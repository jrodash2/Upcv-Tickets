{% extends 'empleados/base.html' %}
{% load static %}

{% block content %}
<div class="page-body">
  <div class="container-fluid">

    <!-- Fila de gráficas -->
    <div class="row mt-4">
      <!-- Gráfica: Contratos Vigentes -->
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h5 class="card-title">Contratos Vigentes</h5>
          </div>
          <div class="card-body">
            <div id="contratosVigentesChart"></div>
          </div>
        </div>
      </div>

      <!-- Gráfica: Contratos por Año -->
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h5 class="card-title">Contratos por Año</h5>
          </div>
          <div class="card-body">
            <div id="contratosPorAnioChart"></div>
          </div>
        </div>
      </div>
    </div>
<!-- Fila de la tabla de últimos contratos -->
<div class="row mt-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title">Últimos Contratos Registrados</h5>
      </div>
      <div class="card-body table-responsive">
        <table id="ultimosContratosTable" class="table table-striped align-middle">
          <thead>
            <tr>
              <th>Foto</th>
              <th>Nombres</th>
              <th>Apellidos</th>
              <th>Fecha Inicio</th>
              <th>Fecha Vencimiento</th>
              <th>Creado</th>
            </tr>
          </thead>
          <tbody>
            {% for contrato in ultimos_contratos %}
            <tr>
              <td>
                {% if contrato.empleado.imagen %}
                  <img src="{{ contrato.empleado.imagen.url }}" alt="Foto de {{ contrato.empleado.nombres }}" class="img-thumbnail" style="width: 60px; height: 60px; object-fit: cover; border-radius: 50%;">
                {% else %}
                  <p><em>Sin foto disponible</em></p>
                {% endif %}
              </td>
              <td>{{ contrato.empleado.nombres }}</td>
              <td>{{ contrato.empleado.apellidos }}</td>
              <td>{{ contrato.fecha_inicio|date:"d/m/Y" }}</td>
              <td>{{ contrato.fecha_vencimiento|date:"d/m/Y" }}</td>
              <td>{{ contrato.created_at|date:"d/m/Y H:i" }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
</div>
</div>
{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
  $(document).ready(function() {
    // Función para mover la última fila al principio con animación
    function rotateRows() {
      let lastRow = $('#ultimosContratosTable tbody tr:last');
      lastRow.fadeOut(500, function() {
        $(this).prependTo('#ultimosContratosTable tbody').fadeIn(500);
      });
    }

    // Repetir cada 3 segundos
    setInterval(rotateRows, 7000);
  });
</script>
{% endblock %}


<!-- Script de ApexCharts -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
  // Donut: Contratos vigentes vs no vigentes
  const optionsContratosVigentes = {
    chart: { type: 'donut', height: 350 },
    series: [{{ datos_empleados.contratos_vigentes }}, {{ datos_empleados.contratos_no_vigentes }}],
    labels: ['Vigentes', 'No Vigentes'],
    colors: ['#0c4a6e', '#4cb8a4'],
    tooltip: {
      y: { formatter: val => val + ' contratos' }
    }
  };
  new ApexCharts(document.querySelector("#contratosVigentesChart"), optionsContratosVigentes).render();

  // Barras: Contratos por año
  const contratosPorAnio = {{ contratos_por_anio|safe }};
  const contratosLabels = contratosPorAnio.map(item => item.anio);
  const contratosData = contratosPorAnio.map(item => item.total);
  const optionsContratosAnio = {
    chart: { type: 'bar', height: 350, toolbar: { show: false } },
    series: [{ name: 'Contratos', data: contratosData }],
    xaxis: { categories: contratosLabels },
    colors: ['#0c4a6e'],
    tooltip: {
      y: { formatter: val => val + ' contratos' }
    }
  };
  new ApexCharts(document.querySelector("#contratosPorAnioChart"), optionsContratosAnio).render();
</script>
{% endblock %}
