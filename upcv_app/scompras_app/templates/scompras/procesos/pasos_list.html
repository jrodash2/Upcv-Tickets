{% extends 'scompras/base.html' %}
{% load static %}

{% block content %}
{% include 'components/modal_theme_upcv_styles.html' %}
<div class="page-body">
  <div class="container-fluid">
    <div class="row justify-content-center">
      <div class="col-xl-10">
        <nav aria-label="breadcrumb" class="mb-3">
          <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="{% url 'scompras:tipos_proceso_list' %}">Tipos</a></li>
            <li class="breadcrumb-item"><a href="{% url 'scompras:subtipos_proceso_list' tipo.id %}">Subtipos</a></li>
            <li class="breadcrumb-item active" aria-current="page">Pasos</li>
          </ol>
        </nav>
        <div class="card shadow-sm">
          <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <div>
              <h4 class="mb-0">Pasos del proceso</h4>
              <small class="text-muted">
                Tipo: {{ tipo.nombre }}
                {% if subtipo %} / Subtipo: {{ subtipo.nombre }}{% else %} / Sin subtipo{% endif %}
              </small>
            </div>
            <button
              class="btn btn-primary"
              data-bs-toggle="modal"
              data-bs-target="#modalPaso"
              data-mode="create"
              data-url="{% if subtipo %}{% url 'scompras:paso_create_subtipo' subtipo.id %}{% else %}{% url 'scompras:paso_create_tipo' tipo.id %}{% endif %}"
            >
              Nuevo paso
            </button>
          </div>
          <div class="card-body">
            <div id="pageAlert" class="alert alert-success d-none" role="alert"></div>
            <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead class="table-light">
                  <tr>
                    <th>#</th>
                    <th>Título</th>
                    <th>Duración</th>
                    <th class="text-center">Activo</th>
                    <th class="text-end">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  {% for paso in pasos %}
                  <tr>
                    <td>{{ paso.numero }}</td>
                    <td>{{ paso.titulo }}</td>
                    <td>{{ paso.duracion_referencia|default:"-" }}</td>
                    <td class="text-center">
                      {% if paso.activo %}
                        <span class="badge bg-success">Activo</span>
                      {% else %}
                        <span class="badge bg-secondary">Inactivo</span>
                      {% endif %}
                    </td>
                    <td class="text-end">
                      <button
                        class="btn btn-outline-secondary btn-sm"
                        data-bs-toggle="modal"
                        data-bs-target="#modalPaso"
                        data-mode="edit"
                        data-url="{% url 'scompras:paso_update' paso.id %}"
                        data-numero="{{ paso.numero }}"
                        data-titulo="{{ paso.titulo }}"
                        data-duracion="{{ paso.duracion_referencia }}"
                        data-activo="{% if paso.activo %}1{% else %}0{% endif %}"
                      >
                        Editar
                      </button>
                      <button
                        class="btn btn-outline-warning btn-sm js-toggle"
                        data-url="{% url 'scompras:paso_toggle' paso.id %}"
                      >
                        {% if paso.activo %}Desactivar{% else %}Activar{% endif %}
                      </button>
                      <button
                        class="btn btn-danger btn-sm"
                        data-bs-toggle="modal"
                        data-bs-target="#modalEliminarPaso{{ paso.id }}"
                      >
                        Eliminar
                      </button>
                    </td>
                  </tr>
                  {% empty %}
                  <tr>
                    <td colspan="5" class="text-center text-muted">No hay pasos registrados.</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
        {% for paso in pasos %}
        <div class="modal fade" id="modalEliminarPaso{{ paso.id }}" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered modal-md">
            <div class="modal-content dark-sign-up modal-theme-upcv">
              <div class="modal-body social-profile text-start p-4">
                {% include 'components/modal_header_upcv.html' with title='Eliminar paso' subtitle='Esta acción eliminará el paso seleccionado de forma permanente.' %}
                <p class="mb-0">¿Seguro que desea eliminar el paso <strong>#{{ paso.numero }} {{ paso.titulo }}</strong>? Esta acción no se puede deshacer.</p>

                <div class="modal-footer justify-content-center border-top-0 mt-4">
                  <button type="button" class="btn btn-cancel-upcv" data-bs-dismiss="modal">Cancelar</button>
                  <form method="post" action="{% url 'scompras:paso_proceso_eliminar' paso.id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger px-4">Confirmar</button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

{% include 'scompras/procesos/partials/_modal_paso.html' %}
{% endblock %}

{% block extra_js %}
<script>
  const getCookie = (name) => {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return '';
  };

  const showAlert = (message, type = 'success') => {
    const alert = document.getElementById('pageAlert');
    alert.textContent = message;
    alert.classList.remove('d-none', 'alert-success', 'alert-danger');
    alert.classList.add(type === 'success' ? 'alert-success' : 'alert-danger');
    setTimeout(() => {
      alert.classList.add('d-none');
    }, 2500);
  };

  const renderErrors = (container, errors) => {
    container.innerHTML = '';
    const list = document.createElement('ul');
    list.classList.add('mb-0');
    Object.entries(errors).forEach(([field, messages]) => {
      messages.forEach((message) => {
        const item = document.createElement('li');
        item.textContent = `${field}: ${message}`;
        list.appendChild(item);
      });
    });
    container.appendChild(list);
    container.classList.remove('d-none');
  };

  const pasoModal = document.getElementById('modalPaso');
  const pasoForm = document.getElementById('pasoForm');
  const pasoErrors = document.getElementById('pasoFormErrors');

  if (pasoModal) {
    pasoModal.addEventListener('show.bs.modal', (event) => {
      const button = event.relatedTarget;
      if (!button) return;
      const mode = button.getAttribute('data-mode');
      const url = button.getAttribute('data-url');
      document.getElementById('pasoModalTitle').textContent =
        mode === 'edit' ? 'Editar paso' : 'Nuevo paso';
      pasoForm.dataset.url = url;
      pasoErrors.classList.add('d-none');
      pasoErrors.innerHTML = '';
      if (mode === 'edit') {
        document.getElementById('pasoNumero').value = button.getAttribute('data-numero') || '';
        document.getElementById('pasoTitulo').value = button.getAttribute('data-titulo') || '';
        document.getElementById('pasoDuracion').value = button.getAttribute('data-duracion') || '';
        document.getElementById('pasoActivo').checked = button.getAttribute('data-activo') === '1';
      } else {
        pasoForm.reset();
        document.getElementById('pasoActivo').checked = true;
      }
    });
  }

  if (pasoForm) {
    pasoForm.addEventListener('submit', (event) => {
      event.preventDefault();
      const url = pasoForm.dataset.url;
      const formData = new FormData(pasoForm);
      fetch(url, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken') },
        body: formData,
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            const modalInstance = bootstrap.Modal.getInstance(pasoModal);
            if (modalInstance) modalInstance.hide();
            showAlert(data.message || 'Guardado');
            setTimeout(() => {
              window.location.reload();
            }, 900);
          } else {
            renderErrors(pasoErrors, data.errors || {});
          }
        })
        .catch(() => {
          showAlert('No fue posible guardar los cambios.', 'danger');
        });
    });
  }

  document.querySelectorAll('.js-toggle').forEach((button) => {
    button.addEventListener('click', () => {
      fetch(button.dataset.url, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken') },
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            showAlert(data.message || 'Actualizado');
            setTimeout(() => {
              window.location.reload();
            }, 900);
          } else {
            showAlert('No fue posible actualizar.', 'danger');
          }
        })
        .catch(() => showAlert('No fue posible actualizar.', 'danger'));
    });
  });
</script>
{% endblock %}
