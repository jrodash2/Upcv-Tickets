{% extends 'scompras/base.html' %}
{% load static %}

{% block content %}
{% include 'components/modal_theme_upcv_styles.html' %}
<div class="page-body">
  <div class="container-fluid">
    <div class="page-title">
      <div class="row align-items-center">
        <div class="col-8">
          <h2 class="mb-0">Tipos de proceso de compra</h2>
          <p class="text-muted mb-0">Administra tipos, subtipos y pasos asociados.</p>
        </div>
        <div class="col-4 text-end">
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalCrearTipo">+ Crear tipo</button>
          <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#modalCrearSubtipo">+ Crear subtipo</button>
        </div>
      </div>
    </div>

    <div class="row g-3">
      {% for tipo in tipos %}
      <div class="col-lg-6">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h5 class="mb-1">{{ tipo.nombre }}</h5>
                <span class="badge bg-light text-muted">{{ tipo.codigo }}</span>
                {% if not tipo.activo %}
                  <span class="badge bg-danger">Inactivo</span>
                {% endif %}
              </div>
              <div class="d-flex gap-2">
                <a class="btn btn-outline-primary btn-sm" href="{% url 'scompras:pasos_tipo_proceso' tipo.id %}">Ver pasos</a>
                <button
                  class="btn btn-outline-secondary btn-sm"
                  data-bs-toggle="modal"
                  data-bs-target="#modalEditarTipo"
                  data-id="{{ tipo.id }}"
                  data-nombre="{{ tipo.nombre }}"
                  data-codigo="{{ tipo.codigo }}"
                  data-activo="{% if tipo.activo %}1{% else %}0{% endif %}"
                >
                  Editar
                </button>
              </div>
            </div>
            <div class="mt-3">
              <h6 class="mb-2">Subtipos</h6>
              {% if tipo.subtipos.all %}
                <ul class="mb-0">
                  {% for subtipo in tipo.subtipos.all %}
                    <li>{{ subtipo.nombre }} {% if not subtipo.activo %}<span class="text-danger">(Inactivo)</span>{% endif %}</li>
                  {% empty %}
                    <li class="text-muted">Sin subtipos.</li>
                  {% endfor %}
                </ul>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      {% empty %}
      <div class="col-12">
        <div class="alert alert-info">No hay tipos de proceso registrados.</div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<div class="modal fade" id="modalCrearTipo" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content dark-sign-up modal-theme-upcv">
      <div class="modal-body social-profile text-start p-4">
        {% include 'components/modal_header_upcv.html' with title='Crear tipo de proceso' subtitle='Complete la informaci贸n del nuevo tipo de proceso.' %}

        <form id="formCrearTipo" data-url="{% url 'scompras:crear_tipo_proceso' %}">
          {% csrf_token %}
          <div class="mb-3">
            <label class="form-label fw-semibold">Nombre</label>
            {{ tipo_form.nombre }}
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold">C贸digo</label>
            {{ tipo_form.codigo }}
          </div>
          <div class="form-check">
            {{ tipo_form.activo }}
            <label class="form-check-label">Activo</label>
          </div>

          <div class="modal-footer justify-content-center border-top-0 mt-4">
            <button type="submit" form="formCrearTipo" class="btn btn-primary px-4">Guardar</button>
            <button type="button" class="btn btn-cancel-upcv" data-bs-dismiss="modal">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalEditarTipo" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content dark-sign-up modal-theme-upcv">
      <div class="modal-body social-profile text-start p-4">
        {% include 'components/modal_header_upcv.html' with title='Editar tipo de proceso' subtitle='Actualice los campos del tipo de proceso seleccionado.' %}

        <form id="formEditarTipo">
          {% csrf_token %}
          <div class="mb-3">
            <label class="form-label fw-semibold">Nombre</label>
            <input type="text" name="nombre" id="editarTipoNombre" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold">C贸digo</label>
            <input type="text" name="codigo" id="editarTipoCodigo" class="form-control" required>
          </div>
          <div class="form-check">
            <input type="checkbox" name="activo" id="editarTipoActivo" class="form-check-input">
            <label class="form-check-label">Activo</label>
          </div>

          <div class="modal-footer justify-content-center border-top-0 mt-4">
            <button type="submit" form="formEditarTipo" class="btn btn-primary px-4">Guardar</button>
            <button type="button" class="btn btn-cancel-upcv" data-bs-dismiss="modal">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalCrearSubtipo" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content dark-sign-up modal-theme-upcv">
      <div class="modal-body social-profile text-start p-4">
        {% include 'components/modal_header_upcv.html' with title='Crear subtipo' subtitle='Asocie y configure un nuevo subtipo para el proceso.' %}

        <form id="formCrearSubtipo" data-url="{% url 'scompras:crear_subtipo_proceso' %}">
          {% csrf_token %}
          <div class="mb-3">
            <label class="form-label fw-semibold">Tipo</label>
            {{ subtipo_form.tipo }}
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold">Nombre</label>
            {{ subtipo_form.nombre }}
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold">C贸digo</label>
            {{ subtipo_form.codigo }}
          </div>
          <div class="form-check">
            {{ subtipo_form.activo }}
            <label class="form-check-label">Activo</label>
          </div>

          <div class="modal-footer justify-content-center border-top-0 mt-4">
            <button type="submit" form="formCrearSubtipo" class="btn btn-primary px-4">Guardar</button>
            <button type="button" class="btn btn-cancel-upcv" data-bs-dismiss="modal">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const getCookie = (name) => {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return '';
  };

  const submitForm = (form, url) => {
    const formData = new FormData(form);
    fetch(url, {
      method: 'POST',
      headers: { 'X-CSRFToken': getCookie('csrftoken') },
      body: formData,
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        window.location.reload();
      } else {
        alert('No fue posible guardar los cambios.');
      }
    })
    .catch(() => alert('No fue posible guardar los cambios.'));
  };

  const formCrearTipo = document.getElementById('formCrearTipo');
  if (formCrearTipo) {
    formCrearTipo.addEventListener('submit', (event) => {
      event.preventDefault();
      submitForm(formCrearTipo, formCrearTipo.dataset.url);
    });
  }

  const formCrearSubtipo = document.getElementById('formCrearSubtipo');
  if (formCrearSubtipo) {
    formCrearSubtipo.addEventListener('submit', (event) => {
      event.preventDefault();
      submitForm(formCrearSubtipo, formCrearSubtipo.dataset.url);
    });
  }

  const modalEditarTipo = document.getElementById('modalEditarTipo');
  if (modalEditarTipo) {
    modalEditarTipo.addEventListener('show.bs.modal', (event) => {
      const button = event.relatedTarget;
      if (!button) return;
      const id = button.getAttribute('data-id');
      document.getElementById('editarTipoNombre').value = button.getAttribute('data-nombre');
      document.getElementById('editarTipoCodigo').value = button.getAttribute('data-codigo');
      document.getElementById('editarTipoActivo').checked = button.getAttribute('data-activo') === '1';
      const formEditar = document.getElementById('formEditarTipo');
      formEditar.dataset.url = `/scompras/tipos-proceso/${id}/editar/`;
    });
  }

  const formEditarTipo = document.getElementById('formEditarTipo');
  if (formEditarTipo) {
    formEditarTipo.addEventListener('submit', (event) => {
      event.preventDefault();
      submitForm(formEditarTipo, formEditarTipo.dataset.url);
    });
  }
</script>
{% endblock %}
